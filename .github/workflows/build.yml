name: Build Unsigned IPA for AltStore

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install dependencies (CocoaPods)
        if: hashFiles('Podfile') != ''
        run: pod install

      - name: Install dependencies (SPM)
        if: hashFiles('Package.swift') != ''
        run: swift package resolve

      - name: Build app without code signing
        env:
          SCHEME_NAME: Tally # Replace with your actual scheme name
        run: |
          # Build the app without signing
          xcodebuild clean build \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath $RUNNER_TEMP/app.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Create unsigned IPA
        run: |
          # Create Payload directory structure
          mkdir -p $RUNNER_TEMP/Payload

          # Find and copy the .app bundle
          APP_PATH=$(find $RUNNER_TEMP/app.xcarchive/Products/Applications -name "*.app" -maxdepth 1)
          cp -r "$APP_PATH" $RUNNER_TEMP/Payload/

          # Create IPA (which is just a renamed zip file)
          cd $RUNNER_TEMP
          zip -r app-unsigned.ipa Payload

          # Verify IPA was created
          ls -lh app-unsigned.ipa

      - name: Get version info
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=$(date +%Y%m%d-%H%M%S)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## üì± Unsigned IPA for AltStore

            This is an **unsigned IPA** that you can install using AltStore with your own Apple ID.

            ### Installation Instructions

            #### Option 1: Using AltStore (Recommended)
            1. **Download AltStore** on your iOS device if you haven't already
            2. **Download the IPA** file from the assets below
            3. Open **AltStore** on your device
            4. Tap the **"+"** button in the "My Apps" tab
            5. Select the downloaded IPA file
            6. **Sign in** with your Apple ID when prompted
            7. Wait for installation to complete

            #### Option 2: Using Sideloadly
            1. Download **Sideloadly** from [sideloadly.io](https://sideloadly.io)
            2. Connect your iOS device to your computer
            3. Drag the IPA file into Sideloadly
            4. Enter your **Apple ID** credentials
            5. Click **Start** to begin sideloading

            ### ‚ö†Ô∏è Important Notes

            - Apps signed with a **free Apple account expire after 7 days**
            - You can have a maximum of **3 sideloaded apps** at once
            - Enable **Background Refresh** in AltStore settings to auto-refresh apps
            - Keep **AltServer running** on your computer (must be on same WiFi network)

            ### üîÑ Auto-Refresh Setup (Recommended)

            To avoid manually refreshing every 7 days:
            1. Install **AltServer** on your computer (Windows/Mac)
            2. Keep AltServer **running** while on the same WiFi as your device
            3. Enable **Background App Refresh** for AltStore in iOS Settings
            4. AltStore will automatically refresh apps before they expire

          draft: false
          prerelease: false
          files: ${{ runner.temp }}/app-unsigned.ipa

      - name: Upload IPA as artifact (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-ipa
          path: ${{ runner.temp }}/app-unsigned.ipa
          retention-days: 15
