name: Build Unsigned IPA for AltStore

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install dependencies (CocoaPods)
        if: hashFiles('Podfile') != ''
        run: pod install

      - name: Install dependencies (SPM)
        if: hashFiles('Package.swift') != ''
        run: swift package resolve

      - name: Get version info
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION_TAG=${GITHUB_REF#refs/tags/}
          else
            VERSION_TAG=$(date +%Y%m%d-%H%M%S)
          fi

          if [[ "$VERSION_TAG" == v* ]]; then
            VERSION=${VERSION_TAG#v}
          else
            VERSION=$VERSION_TAG
          fi

          echo "version_tag=$VERSION_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build app without code signing
        env:
          SCHEME_NAME: Tally # Replace with your actual scheme name
          MARKETING_VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Build the app without signing
          xcodebuild clean build \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath $RUNNER_TEMP/app.xcarchive \
            archive \
            MARKETING_VERSION="$MARKETING_VERSION" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Create unsigned IPA
        run: |
          # Create Payload directory structure
          mkdir -p $RUNNER_TEMP/Payload

          # Find and copy the .app bundle
          APP_PATH=$(find $RUNNER_TEMP/app.xcarchive/Products/Applications -name "*.app" -maxdepth 1)
          cp -r "$APP_PATH" $RUNNER_TEMP/Payload/

          # Create IPA (which is just a renamed zip file)
          cd $RUNNER_TEMP
          zip -r Tally.ipa Payload

          # Verify IPA was created
          ls -lh Tally.ipa

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version_tag }}
          name: Release ${{ steps.version.outputs.version_tag }}
          body: |
            ## ðŸ“± Tally IPA for AltStore

            This is an **unsigned IPA** that you can install using AltStore with your own Apple ID.

            ### Installation Instructions

            #### Option 1: Using AltStore
            1. **Download AltStore** on your iOS device if you haven't already
            2. **Download the IPA** file from the assets below
            3. Open **AltStore** on your device
            4. Tap the **"+"** button in the "My Apps" tab
            5. Select the downloaded IPA file
            6. **Sign in** with your Apple ID when prompted
            7. Wait for installation to complete

            #### Option 2: Self-Build
            1. Clone the repository and check out the desired tag
            2. Open the Xcode project and select the appropriate scheme
            3. Connect your iOS device and select it as the build target
            4. Build and run the app on your device (Xcode will handle signing with your Apple ID)

            ### âš ï¸ Important Notes

            - Apps signed with a **free Apple account expire after 7 days**
            - You can have a maximum of **3 sideloaded apps** at once
            - Enable **Background Refresh** in AltStore settings to auto-refresh apps
            - Keep **AltServer running** on your computer (must be on same WiFi network)

            ### ðŸ”„ Auto-Refresh Setup

            To avoid manually refreshing every 7 days:
            1. Install **AltServer** on your computer (Windows/Mac)
            2. Keep AltServer **running** while on the same WiFi as your device
            3. Enable **Background App Refresh** for AltStore in iOS Settings
            4. AltStore will automatically refresh apps before they expire

          draft: false
          prerelease: false
          files: ${{ runner.temp }}/Tally.ipa

      - name: Update Altstore.json
        env:
          VERSION_TAG: ${{ steps.version.outputs.version_tag }}
          REPO: ${{ github.repository }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail

          # Ensure we're on the default branch (tag builds are detached HEAD)
          git fetch origin "${DEFAULT_BRANCH}"
          git checkout "${DEFAULT_BRANCH}"

          # Strip leading "v" from tag if present for AltStore version field
          if [[ "$VERSION_TAG" == v* ]]; then
            VERSION="${VERSION_TAG#v}"
          else
            VERSION="$VERSION_TAG"
          fi

          IPA_PATH="${RUNNER_TEMP}/Tally.ipa"
          IPA_SIZE=$(stat -f%z "$IPA_PATH")
          RELEASE_URL="https://github.com/${REPO}/releases/download/${VERSION_TAG}/Tally.ipa"
          RELEASE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          jq --arg version "$VERSION" \
             --arg url "$RELEASE_URL" \
             --arg date "$RELEASE_DATE" \
             --argjson size "$IPA_SIZE" \
             '
             .apps[0].versions |=
               ([{
                 downloadURL: $url,
                 size: $size,
                 version: $version,
                 date: $date,
                 localizedDescription: "automated release for version: " + $version
               }] + .)
             ' Altstore.json > Altstore.json.tmp
          mv Altstore.json.tmp Altstore.json

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Altstore.json
          if git diff --cached --quiet; then
            echo "Altstore.json already up to date."
            exit 0
          fi
          git commit -m "chore: update Altstore.json for $VERSION_TAG"
          git push origin "${DEFAULT_BRANCH}"

      - name: Upload IPA as artifact (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: Tally-ipa
          path: ${{ runner.temp }}/Tally.ipa
          retention-days: 15
